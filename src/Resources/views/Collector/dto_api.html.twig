{% extends '@WebProfiler/Profiler/layout.html.twig' %}

{# =====================================================================
   Toolbar
   ===================================================================== #}
{% block toolbar %}
    {% set meta      = collector.data.meta|default({}) %}
    {% set invalid   = collector.data.invalid|default(false) %}
    {% set hasDto    = collector.data.hasDto|default(false) %}
    {% set ctrl      = meta.controller|default('') %}
    {% set meth      = meta.method|default('') %}
    {% set opTitle   = (meta.summary|default(null) ?: (ctrl ~ (meth ? '::' ~ meth : '')))|trim(':') ?: 'DTO API' %}
    {% set status    = invalid ? 'red' : (hasDto ? 'green' : '') %}

    {% set icon %}
        <span class="sf-toolbar-value" title="DTO API">
            <svg width="24" height="24" viewBox="0 0 24 24" style="vertical-align:middle">
                <rect x="3" y="4" width="18" height="14" rx="2" ry="2" fill="currentColor"/>
                <path d="M7 8h10M7 12h6M7 16h8" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
        </span>
    {% endset %}

    {% set text %}
        <div class="sf-toolbar-info-piece">
            <b>Operation</b>
            <span title="{{ opTitle }}">{{ opTitle }}</span>
        </div>
        <div class="sf-toolbar-info-piece">
            <b>Tag</b>
            <span>{{ meta.tag|default('—') }}</span>
        </div>
        <div class="sf-toolbar-info-piece">
            <b>Request DTO</b>
            <span class="sf-toolbar-status">{{ meta.request|default('—') }}</span>
        </div>
        <div class="sf-toolbar-info-piece">
            <b>Valid</b>
            <span class="sf-toolbar-status {{ invalid ? 'sf-toolbar-status-red' : '' }}">{{ invalid ? 'No' : 'Yes' }}</span>
        </div>
    {% endset %}

    {{ include('@WebProfiler/Profiler/toolbar_item.html.twig', { link: true, status: status }) }}
{% endblock %}

{# =====================================================================
   Menu (left sidebar)
   ===================================================================== #}
{% block menu %}
    {% set invalid = collector.data.invalid|default(false) %}
    <span class="label {{ invalid ? 'label-status-error' : '' }}">
        <span class="icon">
            <svg width="24" height="24" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="14" rx="2" ry="2" fill="currentColor"/>
                <path d="M7 8h10M7 12h6M7 16h8" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
        </span>
        <strong>DTO API</strong>
    </span>
{% endblock %}

{# =====================================================================
   Panel
   ===================================================================== #}
{% block panel %}
    {% set meta         = collector.data.meta|default({}) %}
    {% set invalid      = collector.data.invalid|default(false) %}
    {% set hasDto       = collector.data.hasDto|default(false) %}
    {% set reqErr       = collector.data.error|default(null) %}
    {% set responses    = meta.responses|default([]) %}
    {% set violations   = collector.data.request_violations|default([]) %}
    {% set selected = collector.data.selectedResponse ?? null %}

    <style>
        .dtoapi-grid {
            display: grid;
            grid-template-columns:220px 1fr;
            gap: 0;
            border: 1px solid var(--border-color, #ececec);
            border-radius: 6px;
            overflow: hidden
        }

        .dtoapi-row:nth-child(odd) {
            background: var(--sf-toolbar-ajax-info-bg, #fafafa)
        }

        .dtoapi-key, .dtoapi-val {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color, #ececec)
        }

        .dtoapi-key {
            font-weight: 600
        }

        .dtoapi-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            background: #e9ecef
        }

        .dtoapi-badge.ok {
            background: #d1f7d6
        }

        .dtoapi-badge.err {
            background: #ffd6d6
        }

        .dtoapi-badge.note {
            background: #d9e8ff
        }

        .dtoapi-mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace
        }

        .dtoapi-muted {
            color: #666
        }

        .dtoapi-section {
            margin-top: 18px
        }

        .dtoapi-table {
            width: 100%;
            border-collapse: collapse
        }

        .dtoapi-table th, .dtoapi-table td {
            border: 1px solid var(--border-color, #e5e5e5);
            padding: 6px 8px
        }

        .dtoapi-pre {
            white-space: pre-wrap;
            word-break: break-word
        }

        details.dtoapi-fold summary {
            cursor: pointer;
            user-select: none
        }

        details.dtoapi-fold {
            margin: 12px 0
        }
        .dtoapi-row-used { background: #fff9d6; }          /* soft highlight */
        .dtoapi-chip-used { background:#ffe08a; padding:2px 6px; border-radius:3px; font-weight:600; }
    </style>

    <h2>DTO API</h2>

    {# Operation summary #}
    <div class="dtoapi-section">
        <h3>Operation</h3>
        <div class="dtoapi-grid">
            <div class="dtoapi-row dtoapi-key">Controller</div>
            <div class="dtoapi-row dtoapi-val">
                {% set ctrl = meta.controller|default(null) %}
                {% set meth = meta.method|default(null) %}
                {% set file = meta.file|default(null) %}
                {% set line = meta.line|number_format|default(null) %}

                {% if ctrl and meth %}
                    <span class="dtoapi-mono">{{ ctrl }}::{{ meth }}</span>
                {% else %}
                    —
                {% endif %}
            </div>

            <div class="dtoapi-row dtoapi-key">Summary</div>
            <div class="dtoapi-row dtoapi-val">{{ meta.summary|default('—') }}</div>

            <div class="dtoapi-row dtoapi-key">Description</div>
            <div class="dtoapi-row dtoapi-val">{{ meta.description|default('—') }}</div>

            <div class="dtoapi-row dtoapi-key">Tag</div>
            <div class="dtoapi-row dtoapi-val">{{ meta.tag|default('—') }}</div>

            <div class="dtoapi-row dtoapi-key">Deprecated</div>
            <div class="dtoapi-row dtoapi-val">
                {% if meta.deprecated|default(false) %}
                    <span class="dtoapi-badge err">Yes</span>
                {% else %}
                    <span class="dtoapi-badge ok">No</span>
                {% endif %}
            </div>
        </div>
    </div>

    {# Request section #}
    <div class="dtoapi-section">
        <h3>Request</h3>
        <div class="dtoapi-grid">
            <div class="dtoapi-row dtoapi-key">DTO Class</div>
            <div class="dtoapi-row dtoapi-val dtoapi-mono">{{ meta.request|default('—') }}</div>

            <div class="dtoapi-row dtoapi-key">Hydrated</div>
            <div class="dtoapi-row dtoapi-val">
                {% if hasDto %}<span class="dtoapi-badge ok">Yes</span>{% else %}<span
                        class="dtoapi-badge">No</span>{% endif %}
            </div>

            <div class="dtoapi-row dtoapi-key">Valid</div>
            <div class="dtoapi-row dtoapi-val">
                {% if invalid %}<span class="dtoapi-badge err">No</span>{% else %}<span
                        class="dtoapi-badge ok">Yes</span>{% endif %}
            </div>
        </div>

        {% if violations %}
            <details class="dtoapi-fold">
                <summary><strong>Validation issues</strong> ({{ violations|length }})</summary>
                <table class="dtoapi-table">
                    <thead>
                    <tr>
                        <th>Property</th>
                        <th>Message</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for v in violations %}
                        <tr>
                            <td class="dtoapi-mono">{{ (v.propertyPath is defined ? v.propertyPath : (v.path|default('—'))) }}</td>
                            <td>{{ v.message|default('—') }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </details>
        {% endif %}

        {% if reqErr %}
            <details class="dtoapi-fold">
                <summary><strong>Parsing error</strong></summary>
                <div class="dtoapi-pre">
                    <strong>{{ reqErr.class|default('Error') }}</strong>: {{ reqErr.message|default('Unknown error') }}
                </div>
            </details>
        {% endif %}
    </div>

    {# Response section #}
    <div class="dtoapi-section">
        <h3>Declared Responses</h3>
        {% if responses is empty %}
            <p class="dtoapi-muted">
                No method-level <code class="dtoapi-mono">#[DtoApiResponse]</code> found.
                Runtime may fall back to <code class="dtoapi-mono">DtoApiOperation::response</code>.
            </p>
        {% else %}
            <table class="dtoapi-table">
                <thead>
                <tr>
                    <th>Status</th>
                    <th>Content-Type</th>
                    <th>Stream</th>
                    <th>DTO Class</th>
                    <th>Name</th>
                    <th>Description</th>
                </tr>
                </thead>
                <tbody>
                {% for r in responses %}
                    {% set isUsed = selected and (r.status|default(0) == selected.status) and ((r.class|default(null)) == (selected.class|default(null))) %}
                    <tr class="{{ isUsed ? 'dtoapi-row-used' : '' }}">
                        <td>
                            <span class="dtoapi-badge {{ (r.status|default(200)) >= 400 ? 'err' : 'ok' }}">{{ r.status|default(200) }}</span>
                        </td>
                        <td class="dtoapi-mono">{{ r.contentType|default('—') }}</td>
                        <td>{{ r.stream|default(false) ? 'Yes' : 'No' }}</td>
                        <td class="dtoapi-mono">{{ r.class|default('—') }}</td>
                        <td>{{ r.name|default('—') }}</td>
                        <td>{{ r.description|default('—') }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
        <p class="dtoapi-muted">If a controller returns a native <code class="dtoapi-mono">Response</code>, the DTO
            pipeline is bypassed.</p>
    </div>
    <div class="dtoapi-section">
        <h3>Selected Response</h3>
        {% if selected %}
            <div class="dtoapi-grid">
                <div class="dtoapi-row dtoapi-key">Status</div>
                <div class="dtoapi-row dtoapi-val"><span class="dtoapi-badge {{ selected.status >= 400 ? 'err' : 'ok' }}">{{ selected.status }}</span></div>

                <div class="dtoapi-row dtoapi-key">Content-Type</div>
                <div class="dtoapi-row dtoapi-val dtoapi-mono">{{ selected.contentType }}</div>

                <div class="dtoapi-row dtoapi-key">Stream</div>
                <div class="dtoapi-row dtoapi-val">{{ selected.stream ? 'Yes' : 'No' }}</div>

                <div class="dtoapi-row dtoapi-key">DTO Class</div>
                <div class="dtoapi-row dtoapi-val dtoapi-mono">{{ selected.class ?? '—' }}</div>

                <div class="dtoapi-row dtoapi-key">Chosen By</div>
                <div class="dtoapi-row dtoapi-val">
                    <span class="dtoapi-badge note">{{ selected.source == 'exception' ? 'Exception Subscriber' : 'View Subscriber' }}</span>
                </div>
            </div>
        {% else %}
            <p class="dtoapi-muted">No response mapping selected (controller probably returned a native <code class="dtoapi-mono">Response</code>).</p>
        {% endif %}
    </div>
{% endblock %}
